---
lab:
    title: 'ラボ 2 – Azure SQL Database のデプロイ'
    module: 'データ プラットフォーム リソースの計画と実装'
---

# ラボ 2 – Azure SQL Database のデプロイ

**終了までの予想時間:** 35-40 分

**前提条件：** なし

**ラボ ファイル：** なし

# ラボの概要

受講者は、Virtual Network エンドポイントを使用して Azure SQL Database をデプロイするために必要な基本のリソースを構成します。SQL Database への接続は、ラボの VM から Azure Data Studio を使用して検証されます。最後に、Azure Database for PostgreSQL が作成されます。

# ラボの目的

受講者は以下のことができるようになります。

1. 基本的なリソースを構成する

2. Azure SQL Database のデプロイ 

3. Azure Data Studio で Azure SQL Database に接続する

4. Azure Database for PostgreSQL をデプロイする

# シナリオ

AdventureWorks のデータベース管理者は、Virtual Network エンドポイントを含む新しい SQL データベースをセットアップして、デプロイのセキュリティを強化および簡略化します。Azure Data Studio を使用して、データ クエリと結果保持のための SQL Notebook の使用を評価します。

最後に、追加のデータ システムのニーズをサポートするために、Azure Database for PostgreSQL がデプロイされます。

# 演習 1: 基本リソースを構成する

## タスク 1: リソース グループを作成する

1. ブラウザーを起動し、[http://portal.azure.com](http://portal.azure.com/) で Azure portal を開き、適切な資格情報でログインします。

2. ホーム画面で、「**リソース グループ**」 ボタンをクリックします。  

	![画像 1](../images/dp-3300-module-22-lab-01.png)

3. 既存のリソース グループを確認し、「**作成**」 ボタンをクリックして新しいリソース グループを作成します。  

	![画像 7](../images/dp-3300-module-22-lab-02.png)

4. RG の作成に必要な情報を使用して、リソース グループの作成ウィザードを完了します。

	- サブスクリプションが目的のサブスクリプションに設定されていることを確認します

	- リソース グループ名として「**DP-300-Lab02**」と入力します

	- このラボでは、物理的に最も近い場所のリージョンを選択します

	- 「**確認および作成**」 ボタンをクリックします  

	![画像 4](../images/dp-3300-module-22-lab-03.png)

	- 「**作成**」 ボタンをクリックします

## タスク 2: 仮想ネットワークを作成する

1. 左側のナビゲーション ペインで、「**仮想ネットワーク**」 をクリックします  

	![画像 6](../images/dp-3300-module-22-lab-04.png) ラボ

2. 「**+ 追加**」 をクリックして 「**仮想ネットワークの作成**」 ページを開きます。「**基本**」 タブで次の情報を入力します。

	- サブスクリプション: **ラボのサブスクリプションを選択します**

	- リソース グループ: **DP-300-Lab02** リソース グループを選択します

	- 名前: **Lab02-vnet**

	- リージョン: リソース グループを作成したときと同じリージョン (最寄りのリージョン) を選択します  

	![画像 9](../images/dp-3300-module-22-lab-05.png)

	- 「**次へ:**」 をクリックします「**IP アドレス**」 ボタン  

	![画像 10](../images/dp-3300-module-22-lab-06.png)

3. Azure SQL データベース エンドポイントの仮想ネットワークの IP 範囲を構成する

	- 「IP アドレス」 ページで、IPv4 アドレス空間を既定値のままにします。

	- **default** サブネットをクリックします  

	![画像 12](../images/dp-3300-module-22-lab-07.png)

	- 右側の 「サブネットの編集」 フライアウトで、「サービス」 ドロップダウンを展開し、「**Microsoft.Sql**」を選択します  

	![画像 13](../images/dp-3300-module-22-lab-08.png)

	- 「**保存**」 をクリックします

	- 「**確認および作成**」 ボタンをクリックし、新しい仮想ネットワークの設定を確認して、「**作成**」 をクリックします

# 演習 2: Azure SQL Database のデプロイ

## タスク 1: Azure SQL Database のデプロイ

1. Azure portal で、左側のナビゲーション バーの上部にある 「**+ リソースの作成**」 をクリックします  

	![画像 14](../images/dp-3300-module-22-lab-09.png)

2. 上部の検索ボックスで「SQL」を検索し、オプションのリストから 「**SQLデータベース**」 をクリックします  

	![画像 15](../images/dp-3300-module-22-lab-10.png)

3. 「**作成**」 ボタンをクリックします。

4. 「SQL Database の基本の作成」画面に次の情報を入力し、「**次へ**」 をクリックします。**ネットワーク**

	- サブスクリプション: ラボのサブスクリプションを選択します

	- リソース グループ: **DP-300-Lab02** (演習 1 で作成した RG)

	- データベース名: **AdventureWorksLT**
	
	- サーバー: 「**新規作成**」 をクリックします。New Server サイドバーで、フォームに次のように入力します。

		- サーバー名: **dp300-lab-&lt;your initials (lower case)&gt;** (サーバー名はグローバルに一意である必要があります)

		- 場所: 演習 1 と同じリージョンを選択します

        - 認証方法: SQL認証を使用する

		- サーバー管理者のログイン: **dp300admin**

		- パスワード: **dp300P@ssword!**

		- パスワードの確認: **dp300P@ssword!**

		- 新しいサーバーのサイドバーは次のようになります。「**OK**」 をクリックします

		![携帯電話のスクリーンショット、自動生成された説明](../images/dp-3300-module-22-lab-11.png)


    -  エラスティック プールを使用する場合: **いいえ**

    -  コンピューティング + ストレージ: 「**データベースの構成**」 をクリックします

		- 「構成」 画面で、サービスレベルのドロップダウンをクリックします。

		![画像 16](../images/dp-3300-module-22-lab-12.png)

		- 「**Basic**」 をクリックします

		- 「**適用**」 ボタンをクリックします


**注: このサーバー名とログイン情報を書き留めます。このラボの後半で使用します。**

5. 設定を確認し、「**次へ: **」 をクリックします**ネットワーク**  

	![携帯電話のスクリーンショット、自動生成された説明](../images/dp-3300-module-22-lab-13.png)

6. 「ネットワーク」 画面の 「接続方法」 で、「**プライベート エンドポイント**」 ラジオ ボタンをクリックします  

	![画像 19](../images/dp-3300-module-22-lab-14.png)

7. 次に、プライベート エンドポイントの下の 「**プライベート エンドポイントの追加**」 リンクをクリックします。  

	![画像 20](../images/dp-3300-module-22-lab-15.png)

8. 次のように、「プライベート エンドポイントの作成」 フライアウトを完了します。

	- サブスクリプション: ラボのサブスクリプションが選択されていることを確認します

	- リソース グループ: **DP-300-Lab02**

	- 場所: このラボの前のパートで選択したものと同じリージョン

	- 名前: **DP-300-SQL-Endpoint**

	- ターゲット サブリソース: **SqlServer**

	- Virtual Network: **Lab02-vnet**

	- サブネット: **default (10.x.0.0/24)**

	- プライベート DNS 統合オプションは既定値のままにすることができます

	- 「**OK**」 をクリックする前に設定を確認します  

	![画像 21](../images/dp-3300-module-22-lab-16.png)

9. エンドポイントが 「ネットワーク」 ページに表示されていることを確認し、「**次へ**」 をクリックします。 

1. 「Microsoft Defender for SQL」 が 「**後で**」 に設定されていることを確認し、「**次へ**」 をクリックします。

	![画像 22](../images/dp-3300-module-22-lab-17.png)

10. 「追加設定」 ページで、次のオプションを選択します。

	- 「既存のデータを使用」 を 「**サンプル**」 に設定します

	![画像 23](../images/dp-3300-module-22-lab-18.png)

11. 「**確認および**」 をクリックします

12. 設定を確認してから、「**作成**」 をクリックします

13. デプロイが完了したら、「**リソースに移動**」 ボタンをクリックします  


## タスク 2: 新しい SQL Server へのすべての Azure サービス アクセスを有効にする

1. 「SQL Database」 ブレードで、上部のセクションにある SQL サーバー名のリンクをクリックします。  


	![画像 3](../images/dp-3300-module-22-lab-19.png)

2. SQL Server オブジェクトのナビゲーション ブレードで、「セキュリティ」 の下の 「**ネットワーク**」 をクリックします

	![画像 27](../images/dp-3300-module-22-lab-20.png)

3. パブリックネットワークアクセスを「選択したネットワーク」に変更し、ページの下の方にスクロールします。

3. 「Azure サービスとリソースがこのサーバーにアクセスすることを許可する」 を 「**はい**」 に設定します  


	![画像 6](../images/dp-3300-module-22-lab-21.png)

4. 「**保存**」 を選択する

 

# 演習 3: Azure SQL Database に接続する

## タスク 1: Azure Data Studio で Azure SQL DB インスタンスを登録する

1. ラボ VM から Azure Data Studio (ADS) を起動する

	- Azure Data Studio の初回起動時にこのポップアップが表示される場合があります。受信したら、「**はい**」 をクリックします  
![画像 24](../images/dp-3300-module-22-lab-22.png)

2. Azure Data Studio が開いたら、ADS の左側のサイドバーにある 「**接続**」 ボタンをクリックしてから、「**接続の追加**」 ボタンをクリックします。
	
	![画像 30](../images/dp-3300-module-22-lab-25.png)

3. 「接続」 サイドバーの 「接続の詳細」 セクションに、前の演習で作成した SQL Database に接続するための接続情報を入力します

	- 接続の種類: **Microsoft SQL Server**

	- サーバー: 演習 2、タスク 1 で作成した SQL Server の名前を入力します。次に例を示します。**dp300-lab-xx.database.windows.net**  
	「「xx」ではなくイニシャルを使用してサーバー名を作成するように求められたことに注意してください」

	- 認証タイプ: **SQL ログイン**

	- ユーザー名: **dp300admin**

	- パスワード: **dp300P@ssword!**

	- 「データベース」 ドロップダウンを展開して、**AdventureWorksLT.** を選択します。 
	
	**注:** クライアント IP がこのサーバーにアクセスできるようにするためにファイアウォール規則を追加するよう求められることがあります。 
	
	ファイアウォール規則の追加を指示された場合は以下を行ってください。 
	
	「アカウントの追加」 をクリックして Azure アカウントにログインします。新しいファイアウォール規則の作成画面で、「**OK**」 をクリックします。
		
	![画像 10](../images/dp-3300-module-22-lab-26.png)

    または、Azure ポータルで SQL サーバーに移動し、ネットワーク を選択し、 + クライアントIPv4アドレスの追加 を選択して、SQL サーバーのファイアウォール ルールを手動で作成することも可能です。
	
	- サーバー グループは **&lt;default&gt;** に残ります

	- 必要に応じて、名前 (オプション) にデータベースのフレンドリ名を入力できます

	- 設定を確認し、「**接続**」 をクリックします  
	

	![携帯電話のスクリーンショット、自動生成された説明](../images/dp-3300-module-22-lab-27.png)

4. ADS でデータベースに接続し、DB に関するいくつかの基本情報と、オブジェクトの部分的なリストを表示します  

	![携帯電話のスクリーンショット、自動生成された説明](../images/dp-3300-module-22-lab-28.png)

## タスク 2: SQL ノートブックで Azure SQL Database のクエリを実行する

1. このラボの AdventureWorksLT データベースに接続されている Azure Data Studio で、「**新しいノートブック**」 ボタンをクリックします  

	![画像 13](../images/dp-3300-module-22-lab-29.png)

2. ノートブックに新しいテキストボックスを追加するには、「**+テキスト**」 ボタンをクリックします  
	
	![画像 14](../images/dp-3300-module-22-lab-30.png)


**注:** ノートブック内には、クエリまたは結果セットを説明するプレーン テキストを埋め込むことができます。


3. 「**注文の小計別の上位 10 の顧客**」とテキストを入力し、必要に応じて太字にします  

	![携帯電話のスクリーンショット、自動生成された説明](../images/dp-3300-module-22-lab-31.png)

4. ノートブックの最後に新しいコードセルを追加し、クエリを入力します  

	![画像 16](../images/dp-3300-module-22-lab-32.png)

5. 次の SQL ステートメントを新しいセルに貼り付けます

```sql
select top 10 cust.[CustomerID], cust.[CompanyName], sum(sohead.[SubTotal]) as OverallOrderSubTotal

  from [SalesLT].[Customer] cust

    inner join [SalesLT].[SalesOrderHeader] sohead

        on sohead.[CustomerID] = cust.[CustomerID]

   group by cust.[CustomerID], cust.[CompanyName]

   order by [OverallOrderSubTotal] desc
   ```

6. クエリを実行します。結果がクエリのセル内にどのように含まれるかに注意してください。

7. 「**+ テキスト**」 ボタンをクリックして、新しいテキスト セルを追加します。

8. 「**上位 10 件の注文製品カテゴリ**」とテキストを入力し、必要に応じて太字にします

9. もう一度 新しいコードセルを追加し、次の SQL ステートメントをセルに貼り付けます

```sql
select top 10 cat.[Name] as ProductCategory, sum(detail.[OrderQty]) as OrderedQuantity

	from salesLT.[ProductCategory] cat

	   inner join saleslt.[Product] prod
      
	      on prod.[ProductCategoryID] = cat.[ProductCategoryID]

	   inner join salesLT.[SalesOrderDetail] detail

	      on detail.[ProductID] = prod.[ProductID]

	group by cat.[name]

	order by [OrderedQuantity] desc
```
10.  矢印の付いた青い円をクリックしてクエリを実行します 

11. ノートブック内のすべてのセルを実行して結果を表示するには、ツールバーの 「**セルの実行**」 ボタンをクリックします  

	![画像 17](../images/dp-3300-module-22-lab-33.png)

12. Azure Data Studio 内で、「ノートブック」 を 「ファイル」 メニューから D:\Labfiles\Deploy Azure SQL Database (このフォルダーは VM に既に存在します) ディレクトリに保存します。Azure Data Studio 内からノートブックのタブを閉じます。「ファイル」 メニューから 「ノートブックを開く」 を選択し、保存したノートブックを開きます。クエリ結果がノートブックのクエリと一緒に保存されたことを確認します。

# 演習 4: Azure Database for PostgreSQL Database をデプロイする

## タスク 1: PostgreSQL データベースをデプロイする

1. Azure portal で、左側のナビゲーション バーの上部にある 「**+ リソースの作成**」 をクリックします

	![画像 14](../images/dp-3300-module-22-lab-34.png)

2. 上部の検索ボックスで「postgresql」を検索し、結果で 「**Azure Database for PostgreSQL**」 をクリックします  

	![画像 43](../images/dp-3300-module-22-lab-35.png)

3. 「**作成**」 ボタンをクリックします。

4. 「単一サーバー」 オプションの 「**作成**」 をクリックします。フレキシブルサーバーは選択しません。

	![画像 45](../images/dp-3300-module-22-lab-36.png)

5. 以下の情報を 「単一サーバー」の基本 画面に入力します。

	- サブスクリプション: ラボのサブスクリプションを選択します

	- リソース グループ: **DP-300-Lab02** (演習 1 で作成した RG)

	- サーバー名: **dp300-lab02-** **&lt;your initials&gt;** (サーバー名は一意である必要があります）

	- データ ソース: **なし**

	- 場所: このラボ全体で使用されているリージョンを選択します

	- バージョン: **10** または **11**

	- 「コンピューティング + ストレージ」 の下の 「**サーバーの構成**」 リンクをクリックします

		- 「**Basic**」 タブをクリックします

		- 仮想コア スライダーを左端までスライドして、「**1 仮想コア**」 を選択します  

	![画像 46](../images/dp-3300-module-22-lab-37.png)

		- 「**OK**」 をクリックします

	- 管理者ユーザー名: **dp300admin**

	- パスワード: **dp300P@ssword!**

	- パスワードの確認: **dp300P@ssword!**  
	![画像 1](../images/dp-3300-module-22-lab-38.png)

6. 「**確認および作成**」 をクリックします

7. 設定を確認し、「**作成**」 をクリックします

8. デプロイが完了したら、「**リソースに移動**」 をクリックします

## タスク 2: PostgreSQL データベースへのすべての Azure サービス アクセスを有効にする

1. データベースのサイドバーの 「設定」 にある 「**接続セキュリティ**」 ボタンをクリックします  

	![画像 49](../images/dp-3300-module-22-lab-39.png)

2. 「Azure サービスへのアクセスを許可する」 設定を 「**はい**」 にスライドさせます。  「**+ クライアント IP の追加**」 をクリックします  

	![画像 50](../images/dp-3300-module-22-lab-40.png)

3. 左上の 「**保存**」 をクリックします。

## タスク 3: Azure Data Studio で PostgreSQL データベースに接続する

**注:** PostgreSQL 拡張機能を ADS にインストールすると、PostgreSQL にクエリを実行できます。この拡張機能は、ラボの VM にプリインストールされています。


1. ラボの VM 上の Azure Data Studio で、「接続」 サイドバーが展開されていることを確認します。展開されていない場合は、左側のナビゲーション バーの 「**接続**」 ボタンをクリックします。

2. 「**新しい接続**」 ボタンをクリックします  

	![画像 47](../images/dp-3300-module-22-lab-41.png)

3. 「接続の詳細」 サイドバーに次の情報を入力して、前のタスクの PostgreSQL データベースに接続します。

	- 接続の種類: **PostgreSQL**

	- サーバー: タスク 1 で作成した PostgreSQL サーバーの名前を入力します。次に例を示します。**dp300-lab02-doc.database.windows.net** (サーバーの完全な名前は、ポータルの 「概要」 ペインで確認できます。)

	- 認証タイプ: **パスワード**

	- ユーザー名: **dp300admin@dp300-lab02-doc** (ユーザー名には上記で指定したホスト名を含める必要がある点に留意してください。'doc' の代わりにサフィックスを使います) 

	- パスワード: **dp300P@ssword!**

	- データベース名:  **&lt;default&gt;** 

	- サーバー グループ:  **&lt;default&gt;** 

	- 必要に応じて、名前 (オプション) にデータベースのフレンドリ名を入力できます

4. 設定の確認  

	![画像 48](../images/dp-3300-module-22-lab-42.png)

5. **接続** をクリックする

6. PostgreSQL データベースへの 接続を確認します。。  

	![画像 52](../images/dp-3300-module-22-lab-43.png)

 

 
